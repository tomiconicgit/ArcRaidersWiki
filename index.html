<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>LiDAR_17 // SCANNER</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: "Courier New", Courier, monospace;
        }

        /* The canvas where the "LiDAR" shader lives */
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* --- Heads Up Display (HUD) --- */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; /* Let touches pass through to canvas */
            box-shadow: inset 0 0 50px rgba(0, 255, 65, 0.2);
        }

        .hud-element {
            position: absolute;
            color: #00ff41;
            text-shadow: 0 0 5px #00ff41;
            font-weight: bold;
            font-size: 14px;
        }

        /* Top Bar */
        .top-bar {
            top: 50px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid rgba(0, 255, 65, 0.5);
            padding-bottom: 10px;
        }

        /* Center Reticle */
        .reticle {
            top: 50%;
            left: 50%;
            width: 80px;
            height: 80px;
            transform: translate(-50%, -50%);
            border: 2px solid rgba(0, 255, 65, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .reticle::after {
            content: '';
            width: 4px;
            height: 4px;
            background: #00ff41;
            border-radius: 50%;
        }

        /* Bottom Controls */
        .controls {
            bottom: 40px;
            width: 100%;
            display: flex;
            justify-content: center;
            pointer-events: auto; /* Enable buttons */
        }

        .btn-scan {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid #00ff41;
            color: #00ff41;
            font-size: 12px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
            transition: transform 0.1s;
        }

        .btn-scan:active {
            transform: scale(0.9);
            background: #00ff41;
            color: black;
        }

        /* Analysis Popup */
        #analysis-box {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translate(-50%, 0);
            width: 80%;
            background: rgba(0, 20, 0, 0.9);
            border: 1px solid #00ff41;
            padding: 15px;
            display: none;
            flex-direction: column;
            gap: 5px;
            pointer-events: auto;
        }

        .scan-line {
            width: 100%;
            height: 2px;
            background: #00ff41;
            position: absolute;
            top: 50%;
            animation: scan 2s infinite linear;
            opacity: 0.5;
        }

        @keyframes scan {
            0% { transform: translateY(-300px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(300px); opacity: 0; }
        }

        /* Permission Button */
        #start-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            padding: 20px 40px;
            background: #00ff41;
            color: black;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
        }

    </style>
</head>
<body>

    <video id="webcam" playsinline style="display:none;"></video>

    <canvas id="glCanvas"></canvas>

    <div id="ui-layer">
        <div class="hud-element top-bar">
            <span>SYS: ONLINE</span>
            <span id="fps-counter">60 FPS</span>
            <span>LiDAR: SIM</span>
        </div>

        <div class="hud-element reticle">
            <div class="scan-line"></div>
        </div>

        <div class="hud-element" style="bottom: 150px; left: 20px;">
            RANGE: <span id="dist-readout">0.0m</span><br>
            GRID: ACTIVE
        </div>

        <div id="analysis-box" onclick="this.style.display='none'">
            <div style="border-bottom: 1px solid #00ff41; padding-bottom:5px; margin-bottom:5px;">OBJECT ANALYSIS</div>
            <div id="analysis-text" style="font-size: 12px; line-height: 1.4;"></div>
            <small style="color:#00ff41; margin-top:10px;">[TAP TO CLOSE]</small>
        </div>

        <div class="controls">
            <button class="btn-scan" onclick="triggerScan()">CAPTURE</button>
        </div>
    </div>

    <button id="start-btn" onclick="startApp()">INITIALIZE SYSTEM</button>

    <script>
        let gl, program;
        let video = document.getElementById('webcam');
        let canvas = document.getElementById('glCanvas');
        let texture;
        let isRunning = false;

        // --- 1. WebGL Shader Code (The Magic) ---
        // This shader creates the "Edge Detection" look
        const vertexShaderSource = `
            attribute vec2 position;
            varying vec2 vUv;
            void main() {
                vUv = position * 0.5 + 0.5;
                vUv.y = 1.0 - vUv.y; // Flip Y for WebGL
                gl_Position = vec4(position, 0.0, 1.0);
            }
        `;

        const fragmentShaderSource = `
            precision mediump float;
            varying vec2 vUv;
            uniform sampler2D uTexture;
            uniform vec2 uResolution;

            void main() {
                vec2 onePixel = vec2(1.0, 1.0) / uResolution;
                
                // Sobel Edge Detection Kernel
                vec4 n0 = texture2D(uTexture, vUv + onePixel * vec2(-1, -1));
                vec4 n1 = texture2D(uTexture, vUv + onePixel * vec2( 0, -1));
                vec4 n2 = texture2D(uTexture, vUv + onePixel * vec2( 1, -1));
                vec4 n3 = texture2D(uTexture, vUv + onePixel * vec2(-1,  0));
                vec4 n4 = texture2D(uTexture, vUv + onePixel * vec2( 1,  0));
                vec4 n5 = texture2D(uTexture, vUv + onePixel * vec2(-1,  1));
                vec4 n6 = texture2D(uTexture, vUv + onePixel * vec2( 0,  1));
                vec4 n7 = texture2D(uTexture, vUv + onePixel * vec2( 1,  1));

                vec4 sobel_edge_h = n2 + (2.0*n4) + n7 - (n0 + (2.0*n3) + n5);
                vec4 sobel_edge_v = n0 + (2.0*n1) + n2 - (n5 + (2.0*n6) + n7);
                
                vec4 sobel = sqrt((sobel_edge_h * sobel_edge_h) + (sobel_edge_v * sobel_edge_v));

                // Make it green and glowing
                float intensity = length(sobel.rgb);
                
                // If edge is strong, draw green, else black (matrix style)
                vec3 color = vec3(0.0, intensity * 2.0, intensity * 0.5);
                
                // Add a faint grid overlay
                float grid = (mod(gl_FragCoord.x, 20.0) < 1.0 || mod(gl_FragCoord.y, 20.0) < 1.0) ? 0.2 : 0.0;
                
                gl_FragColor = vec4(color + vec3(0.0, grid, 0.0), 1.0);
            }
        `;

        // --- 2. Initialization ---
        async function startApp() {
            document.getElementById('start-btn').style.display = 'none';
            
            try {
                // Get Camera
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } 
                });
                video.srcObject = stream;
                await video.play();

                initWebGL();
                resize();
                window.addEventListener('resize', resize);
                render();
                
                // Start random distance numbers
                setInterval(() => {
                    const d = (Math.random() * 5 + 1).toFixed(2);
                    document.getElementById('dist-readout').innerText = `${d}m`;
                }, 200);

            } catch (err) {
                alert("Camera access denied or not supported. Please enable camera permissions.");
                console.error(err);
            }
        }

        function initWebGL() {
            gl = canvas.getContext('webgl');
            if (!gl) return alert("WebGL not supported");

            // Compile Shaders
            const vs = createShader(gl, gl.VERTEX_SHADER, vertexShaderSource);
            const fs = createShader(gl, gl.FRAGMENT_SHADER, fragmentShaderSource);
            program = createProgram(gl, vs, fs);
            gl.useProgram(program);

            // Fullscreen Triangle
            const buffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
                -1, -1, 3, -1, -1, 3
            ]), gl.STATIC_DRAW);

            const positionLocation = gl.getAttribLocation(program, "position");
            gl.enableVertexAttribArray(positionLocation);
            gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);

            // Create Texture
            texture = gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D, texture);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        }

        // --- 3. Rendering Loop ---
        function render() {
            if (!gl) return;
            
            // Update texture with video frame
            gl.bindTexture(gl.TEXTURE_2D, texture);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, video);

            // Set Resolution Uniform
            const uResolution = gl.getUniformLocation(program, "uResolution");
            gl.uniform2f(uResolution, canvas.width, canvas.height);

            // Draw
            gl.drawArrays(gl.TRIANGLES, 0, 3);
            
            requestAnimationFrame(render);
        }

        // --- 4. Helpers ---
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            gl.viewport(0, 0, canvas.width, canvas.height);
        }

        function createShader(gl, type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                console.error(gl.getShaderInfoLog(shader));
                gl.deleteShader(shader);
                return null;
            }
            return shader;
        }

        function createProgram(gl, vs, fs) {
            const p = gl.createProgram();
            gl.attachShader(p, vs);
            gl.attachShader(p, fs);
            gl.linkProgram(p);
            return p;
        }

        // --- 5. Fun Features ---
        const funObjects = [
            { name: "Unknown Anomaly", comp: "Ectoplasm: 80%" },
            { name: "Structural Weakness", comp: "Integrity: 12%" },
            { name: "Caffeine Source", comp: "Taurine: Detected" },
            { name: "Biological Entity", comp: "Heart Rate: N/A" },
            { name: "Quantum Flux", comp: "Stability: Critical" }
        ];

        function triggerScan() {
            const box = document.getElementById('analysis-box');
            const txt = document.getElementById('analysis-text');
            const btn = document.querySelector('.btn-scan');

            // Haptic Feedback
            if(window.navigator.vibrate) window.navigator.vibrate(200);

            // Visual Flash
            btn.style.background = "#fff";
            setTimeout(() => btn.style.background = "rgba(0,0,0,0.5)", 100);

            // Generate "Data"
            const data = funObjects[Math.floor(Math.random() * funObjects.length)];
            const dist = (Math.random() * 10).toFixed(2);
            
            box.style.display = 'flex';
            txt.innerHTML = `
                <span style="color:#fff">TARGET LOCKED</span><br>
                TYPE: ${data.name}<br>
                DIST: ${dist} meters<br>
                COMP: ${data.comp}<br>
                <br>
                <span style="background:#00ff41; color:black; padding:2px;">SAVE TO DB? [Y/N]</span>
            `;
        }

    </script>
</body>
</html>
